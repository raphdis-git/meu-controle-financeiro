<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finan√ßas Pro - Controle Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .is-paid { opacity: 0.35; text-decoration: line-through; }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.04); }
        .balance-positive { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .balance-negative { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        #edit-modal-overlay { background-color: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px); }
        #yearly-summary-screen { backdrop-filter: blur(8px); }
    </style>
</head>
<body class="p-4 md:p-6">

    <div class="max-w-3xl mx-auto pb-20">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-xl font-bold tracking-tight">üí∞ Finan√ßas Cloud</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Gest√£o Pessoal 2026</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openYearlySummary()" class="bg-slate-900 text-white px-3 py-2 rounded-xl shadow-sm text-[10px] font-bold uppercase hover:bg-black transition">
                    Resumo Anual
                </button>
                <input type="month" id="month-filter" class="bg-white px-3 py-2 rounded-xl shadow-sm border border-slate-200 outline-none text-blue-600 font-bold text-sm">
            </div>
        </header>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-8">
            <div class="bg-white p-4 rounded-2xl border border-slate-100 card-shadow text-center sm:text-left">
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Entradas</p>
                <h2 id="total-income" class="text-base font-bold text-emerald-600">R$ 0,00</h2>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-100 card-shadow text-center sm:text-left">
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Sa√≠das</p>
                <h2 id="total-expense" class="text-base font-bold text-rose-500">R$ 0,00</h2>
            </div>
            <div id="balance-card" class="p-4 rounded-2xl card-shadow col-span-1 text-center sm:text-left transition-colors duration-500">
                <p class="text-[9px] font-bold opacity-70 uppercase mb-1">Saldo Livre</p>
                <h2 id="monthly-net-balance" class="text-base font-bold">R$ 0,00</h2>
            </div>
            <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 card-shadow text-center sm:text-left">
                <p class="text-[9px] font-bold text-amber-600 uppercase mb-1">Pendente</p>
                <h2 id="to-pay-balance" class="text-base font-bold text-amber-700">R$ 0,00</h2>
            </div>
        </div>

        <div class="bg-white p-5 rounded-3xl border border-slate-200 card-shadow mb-8">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Quitar por Categoria (M√™s Atual)</h3>
            <div id="category-summary" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
        </div>

        <div class="bg-white p-6 rounded-3xl border border-slate-200 card-shadow mb-8">
            <form id="finance-form" class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 tracking-widest">Categoria e Vencimento</label>
                    <div class="flex gap-2">
                        <select id="category" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold text-blue-700 text-sm" required></select>
                        <button type="button" onclick="toggleNewCategory()" class="bg-blue-600 text-white w-12 rounded-xl font-bold text-xl hover:bg-blue-700 transition">+</button>
                        <button type="button" onclick="toggleManager()" class="bg-slate-100 text-slate-500 w-12 rounded-xl font-bold hover:bg-slate-200 transition">‚öôÔ∏è</button>
                    </div>
                </div>

                <div id="add-cat-panel" class="hidden p-4 bg-blue-50 rounded-2xl border border-blue-100 space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="custom-cat-name" placeholder="Nome" class="p-2 text-sm border-white rounded-lg outline-none w-full">
                        <input type="number" id="custom-cat-day" min="1" max="31" placeholder="Dia" class="p-2 text-sm border-white rounded-lg outline-none w-full">
                    </div>
                    <button type="button" onclick="saveNewCategory()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-[10px] font-bold uppercase">Cadastrar</button>
                </div>

                <div id="manager-panel" class="hidden p-4 bg-slate-100 rounded-2xl border border-slate-200 space-y-2 text-center">
                    <div id="my-categories-list" class="flex flex-wrap gap-2 justify-center"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 tracking-widest">T√≠tulo do Lan√ßamento</label>
                        <input type="text" id="title" placeholder="Ex: Internet" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 tracking-widest">Valor</label>
                        <input type="text" id="amount" placeholder="R$ 0,00" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold text-blue-600 text-sm" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="type" class="p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-xs font-bold" required>
                        <option value="" disabled selected>Tipo...</option>
                        <option value="saida">üî¥ Gasto</option>
                        <option value="entrada">üü¢ Recebimento</option>
                    </select>
                    <select id="recurrence" onchange="toggleInstallments()" class="p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-xs font-bold" required>
                        <option value="" disabled selected>Repetir...</option>
                        <option value="unico">Uma vez</option>
                        <option value="fixo">Mensal Fixo</option>
                        <option value="parcelado">Parcelado</option>
                    </select>
                    <div id="installments-box" class="hidden">
                        <input type="number" id="installments-count" min="2" placeholder="Qtde Parcelas" class="w-full p-3 bg-blue-50 border border-blue-200 rounded-xl outline-none text-xs font-bold">
                    </div>
                </div>

                <button type="submit" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold shadow-lg hover:bg-black transition">Salvar Lan√ßamento</button>
            </form>
        </div>

        <div class="bg-white rounded-3xl border border-slate-200 card-shadow overflow-hidden">
            <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Movimenta√ß√µes do Per√≠odo</h3>
            </div>
            <table class="w-full text-left">
                <tbody id="transaction-list" class="divide-y divide-slate-50"></tbody>
            </table>
            <div id="loading" class="p-10 text-center text-slate-300 font-bold text-[10px] uppercase">Buscando na nuvem...</div>
        </div>
    </div>

    <div id="edit-modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl space-y-5">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold">Editar Transa√ß√£o</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600">‚úï</button>
            </div>
            <div class="space-y-4">
                <input type="text" id="edit-title" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                <input type="text" id="edit-amount" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold text-blue-600 text-sm">
            </div>
            <div class="flex flex-col gap-2 pt-2">
                <button onclick="confirmEdit(true)" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold text-xs uppercase">Salvar em TODOS os meses futuros</button>
                <button onclick="confirmEdit(false)" class="w-full bg-slate-100 text-slate-700 p-3 rounded-xl font-bold text-xs uppercase">Salvar APENAS neste m√™s</button>
            </div>
        </div>
    </div>

    <div id="yearly-summary-screen" class="hidden fixed inset-0 z-[60] bg-slate-50/95 overflow-y-auto p-4 md:p-8">
        <div class="max-w-3xl mx-auto">
            <header class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black tracking-tight text-slate-800 uppercase">Resumo <span id="display-year"></span></h2>
                <button onclick="closeYearlySummary()" class="bg-white border border-slate-200 px-4 py-2 rounded-2xl shadow-sm font-bold text-xs hover:bg-slate-100 transition">‚úï VOLTAR</button>
            </header>
            <div id="yearly-cards" class="space-y-3"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://cxitsxuqxclucwdlwynp.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_bu8qGEMLijUsVzwQk0Of4w_30CJ2j-U';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let transactions = [];
        let categorySettings = JSON.parse(localStorage.getItem('cat_settings')) || {};
        let currentEditId = null;

        const monthFilter = document.getElementById('month-filter');
        monthFilter.value = new Date().toISOString().substring(0, 7);

        // UI toggles
        function toggleNewCategory() { document.getElementById('add-cat-panel').classList.toggle('hidden'); }
        function toggleManager() { document.getElementById('manager-panel').classList.toggle('hidden'); if(!document.getElementById('manager-panel').classList.contains('hidden')) renderManager(); }
        function toggleInstallments() { document.getElementById('installments-box').classList.toggle('hidden', document.getElementById('recurrence').value !== 'parcelado'); }

        function setupCurrencyInput(id) {
            document.getElementById(id).addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, "");
                value = (value / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                e.target.value = value === 'R$ 0,00' ? '' : value;
            });
        }
        setupCurrencyInput('amount');
        setupCurrencyInput('edit-amount');

        // Fun√ß√µes do Resumo Anual
        function openYearlySummary() {
            const year = monthFilter.value.split('-')[0];
            document.getElementById('display-year').innerText = year;
            const container = document.getElementById('yearly-cards');
            const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            let html = '';
            for (let m = 1; m <= 12; m++) {
                const monthStr = `${year}-${m.toString().padStart(2, '0')}`;
                let inc = 0, exp = 0;
                
                transactions.forEach(t => {
                    if (t.date.startsWith(monthStr)) {
                        if (t.type === 'entrada') inc += t.amount;
                        else exp += t.amount;
                    }
                });

                const net = inc - exp;
                html += `
                    <div class="bg-white p-4 rounded-3xl border border-slate-200 flex items-center justify-between shadow-sm">
                        <div class="w-1/4">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${months[m-1]}</p>
                        </div>
                        <div class="flex flex-1 justify-around text-center px-2">
                            <div>
                                <p class="text-[8px] font-bold text-slate-300 uppercase">Entrada</p>
                                <p class="text-[11px] font-bold text-emerald-600">R$ ${inc.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            </div>
                            <div>
                                <p class="text-[8px] font-bold text-slate-300 uppercase">Sa√≠da</p>
                                <p class="text-[11px] font-bold text-rose-500">R$ ${exp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>
                        <div class="w-1/4 text-right">
                            <p class="text-[8px] font-bold text-slate-300 uppercase">Livre</p>
                            <p class="text-xs font-black ${net >= 0 ? 'text-blue-600' : 'text-rose-700'}">R$ ${net.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
            document.getElementById('yearly-summary-screen').classList.remove('hidden');
        }

        function closeYearlySummary() {
            document.getElementById('yearly-summary-screen').classList.add('hidden');
        }

        // Categorias e Supabase
        async function loadData() {
            const { data, error } = await _supabase.from('transacoes').select('*').order('date', { ascending: true });
            if (!error) { transactions = data; updateCategoryDropdown(); render(); }
            document.getElementById('loading').classList.add('hidden');
        }

        function saveNewCategory() {
            const name = document.getElementById('custom-cat-name').value.trim();
            const day = document.getElementById('custom-cat-day').value;
            if (name && day) {
                categorySettings[name] = { day: day.toString().padStart(2, '0') };
                localStorage.setItem('cat_settings', JSON.stringify(categorySettings));
                updateCategoryDropdown(name); toggleNewCategory();
                document.getElementById('custom-cat-name').value = '';
                document.getElementById('custom-cat-day').value = '';
            }
        }

        function renderManager() {
            const container = document.getElementById('my-categories-list');
            container.innerHTML = '';
            Object.keys(categorySettings).sort().forEach(cat => {
                const div = document.createElement('div');
                div.className = "bg-white border border-slate-200 px-3 py-1.5 rounded-xl text-[10px] font-bold flex items-center gap-2 shadow-sm transition hover:border-blue-300";
                div.innerHTML = `
                    <span class="cursor-pointer text-slate-700" onclick="renameCat('${cat}')">${cat} (${categorySettings[cat].day})</span>
                    <button onclick="removeCat('${cat}')" class="text-rose-400 font-bold hover:text-rose-600 ml-1">√ó</button>
                `;
                container.appendChild(div);
            });
        }

        async function renameCat(oldName) {
            const newName = prompt("Novo nome da categoria:", oldName);
            const newDay = prompt("Novo dia de vencimento padr√£o (01-31):", categorySettings[oldName].day);
            if (newName && newDay) {
                const formattedDay = newDay.padStart(2, '0');
                const { error } = await _supabase.from('transacoes').update({ category: newName }).eq('category', oldName);
                if (error) { alert("Erro ao atualizar: " + error.message); return; }
                categorySettings[newName] = { day: formattedDay };
                if (newName !== oldName) delete categorySettings[oldName];
                localStorage.setItem('cat_settings', JSON.stringify(categorySettings));
                updateCategoryDropdown(); renderManager(); loadData();
            }
        }

        function removeCat(cat) {
            if(confirm(`Excluir o atalho "${cat}"?`)) {
                delete categorySettings[cat];
                localStorage.setItem('cat_settings', JSON.stringify(categorySettings));
                updateCategoryDropdown(); renderManager();
            }
        }

        function updateCategoryDropdown(selected = null) {
            const select = document.getElementById('category');
            let allCats = [...new Set([...transactions.map(t => t.category), ...Object.keys(categorySettings)])].filter(c => c).sort();
            select.innerHTML = '<option value="" disabled selected>Escolha uma categoria...</option>';
            allCats.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.text = cat + (categorySettings[cat] ? ` (Dia ${categorySettings[cat].day})` : '');
                select.add(opt);
            });
            if(selected) select.value = selected;
        }

        async function payCategory(categoryName) {
            const month = monthFilter.value;
            const idsToUpdate = transactions
                .filter(t => t.category === categoryName && t.date.startsWith(month) && t.type === 'saida' && !t.paid)
                .map(t => t.id);
            if (idsToUpdate.length === 0) return;
            if (confirm(`Quitar todos os lan√ßamentos de "${categoryName}"?`)) {
                const { error } = await _supabase.from('transacoes').update({ paid: true }).in('id', idsToUpdate);
                if(!error) loadData();
            }
        }

        function render() {
            const list = document.getElementById('transaction-list');
            const summaryBox = document.getElementById('category-summary');
            list.innerHTML = '';
            summaryBox.innerHTML = '';
            let inc = 0, exp = 0, toPay = 0;
            let catStats = {};

            transactions.forEach(t => {
                if (t.date.startsWith(monthFilter.value)) {
                    const isInc = t.type === 'entrada';
                    if (isInc) inc += t.amount; 
                    else { 
                        exp += t.amount; 
                        if(!t.paid) {
                            toPay += t.amount;
                            catStats[t.category] = (catStats[t.category] || 0) + t.amount;
                        }
                    }
                    const dia = t.date.split('-')[2];
                    const tr = document.createElement('tr');
                    tr.className = `hover:bg-slate-50/50 transition-colors ${t.paid ? 'is-paid' : ''}`;
                    tr.innerHTML = `
                        <td class="p-4 w-12"><button onclick="togglePaid(${t.id}, ${t.paid})" class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${t.paid ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-200'}">${t.paid ? '‚úì' : ''}</button></td>
                        <td class="py-4 px-2">
                            <div class="text-sm font-semibold text-slate-700">${t.title}</div>
                            <div class="text-[9px] text-slate-400 font-bold uppercase tracking-tight">Venc. ${dia} ‚Ä¢ ${t.category}</div>
                        </td>
                        <td class="p-4 text-right font-bold text-sm ${isInc ? 'text-emerald-500' : 'text-slate-600'}">R$ ${t.amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="p-4 text-right flex gap-3 justify-end">
                            <button onclick="openEditModal(${t.id})" class="text-slate-300 hover:text-blue-500">üìù</button>
                            <button onclick="deleteItem(${t.id})" class="text-slate-300 hover:text-rose-500">üóëÔ∏è</button>
                        </td>
                    `;
                    list.appendChild(tr);
                }
            });

            Object.keys(catStats).forEach(cat => {
                const card = document.createElement('div');
                card.className = "flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-2xl";
                card.innerHTML = `
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">${cat}</p>
                        <p class="text-xs font-bold text-rose-500">R$ ${catStats[cat].toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                    </div>
                    <button onclick="payCategory('${cat}')" class="bg-emerald-100 text-emerald-600 text-[10px] font-black px-3 py-2 rounded-xl hover:bg-emerald-600 hover:text-white transition uppercase">Quitar Tudo</button>
                `;
                summaryBox.appendChild(card);
            });

            if(Object.keys(catStats).length === 0) summaryBox.innerHTML = '<p class="text-[10px] text-slate-300 italic">Nenhuma pend√™ncia este m√™s.</p>';
            const net = inc - exp;
            document.getElementById('balance-card').className = `p-4 rounded-2xl card-shadow col-span-1 text-center sm:text-left ${net >= 0 ? 'balance-positive' : 'balance-negative'}`;
            document.getElementById('total-income').innerText = `R$ ${inc.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('total-expense').innerText = `R$ ${exp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('monthly-net-balance').innerText = `R$ ${net.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('to-pay-balance').innerText = `R$ ${toPay.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        async function saveData(e) {
            e.preventDefault();
            const cat = document.getElementById('category').value;
            const amount = parseFloat(document.getElementById('amount').value.replace(/[^\d,]/g, "").replace(",", ".")) || 0;
            const [year, month] = monthFilter.value.split('-');
            const calcDate = `${year}-${month}-${categorySettings[cat]?.day || '01'}`;
            const recType = document.getElementById('recurrence').value;
            let numRep = (recType === 'fixo') ? 12 : (recType === 'parcelado' ? (parseInt(document.getElementById('installments-count').value) || 2) : 1);
            let payloads = [];
            for (let i = 0; i < numRep; i++) {
                let d = new Date(calcDate + 'T12:00:00'); d.setMonth(d.getMonth() + i);
                let title = document.getElementById('title').value;
                if(recType === 'parcelado') title += ` (${(i+1).toString().padStart(2,'0')}/${numRep})`;
                payloads.push({ title, amount, category: cat, type: document.getElementById('type').value, date: d.toISOString().split('T')[0], paid: false });
            }
            await _supabase.from('transacoes').insert(payloads);
            document.getElementById('finance-form').reset();
            loadData();
        }

        async function togglePaid(id, status) { await _supabase.from('transacoes').update({ paid: !status }).eq('id', id); loadData(); }
        async function deleteItem(id) { if(confirm("Excluir?")) { await _supabase.from('transacoes').delete().eq('id', id); loadData(); } }
        
        function openEditModal(id) {
            currentEditId = id;
            const t = transactions.find(x => x.id === id);
            document.getElementById('edit-title').value = t.title;
            document.getElementById('edit-amount').value = t.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('edit-modal-overlay').classList.remove('hidden');
        }
        function closeEditModal() { document.getElementById('edit-modal-overlay').classList.add('hidden'); }
        async function confirmEdit(prop) {
            const t = transactions.find(x => x.id === currentEditId);
            const val = parseFloat(document.getElementById('edit-amount').value.replace(/[^\d,]/g, "").replace(",", ".")) || 0;
            const title = document.getElementById('edit-title').value;
            if(prop) {
                const base = t.title.split(' (')[0];
                await _supabase.from('transacoes').update({ title, amount: val }).match({ category: t.category }).filter('title', 'ilike', `%${base}%`).gte('date', t.date);
            } else {
                await _supabase.from('transacoes').update({ title, amount: val }).eq('id', currentEditId);
            }
            closeEditModal(); loadData();
        }

        document.getElementById('finance-form').onsubmit = saveData;
        monthFilter.onchange = loadData;
        loadData();
    </script>
</body>
</html>
